<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¥Š</text></svg>">
    <title>èƒ–æè€æ¿ï¼šç»ˆæç‰ˆ</title>
    <style>
        /* --- å…¨å±€è®¾ç½® --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #Fdf5e6; /* ç±³è‰²èƒŒæ™¯å¢™ */
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: manipulation;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100vh;
            max-height: 600px;
            background-color: #Fdf5e6;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- åœºæ™¯å…ƒç´  --- */
        .wall-trim {
            position: absolute;
            bottom: 30%;
            width: 100%;
            height: 15px;
            background-color: #8D6E63;
            border-top: 2px solid #5D4037;
            border-bottom: 2px solid #5D4037;
            z-index: 2;
        }

        .floor {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30%;
            background-color: #D7CCC8;
            z-index: 1;
        }

        /* --- UI ç•Œé¢ --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }

        .top-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            pointer-events: auto;
        }

        .btn {
            background: #fff;
            border: 2px solid #333;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        .hp-container {
            width: 100%;
            max-width: 500px;
            height: 32px;
            background: #333;
            border: 3px solid #000;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        #hp-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #ff4d4d, #cc0000);
            transition: width 0.2s ease-out;
        }

        #hp-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 900;
            text-shadow: 1px 1px 2px black;
            font-size: 16px;
        }

        /* --- æŠ€èƒ½æ  --- */
        .skill-bar {
            position: absolute;
            right: 20px;
            top: 100px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 101;
            pointer-events: auto;
        }

        .skill-icon {
            width: 55px;
            height: 55px;
            background: white;
            border: 3px solid #333;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            position: relative;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }
        .skill-icon:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.3); }

        .cooldown-mask {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: rgba(0,0,0,0.7);
            border-radius: 9px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            transition: height 0.1s linear;
        }

        .key-hint {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background: #333;
            color: #fff;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* --- è€æ¿ CSS ç»˜ç”» (æ ¸å¿ƒéƒ¨åˆ†) --- */
        #boss-wrapper {
            position: absolute;
            bottom: 18%; /* ç«™åœ¨åœ°æ¿ä¸Š */
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 380px;
            z-index: 10;
            transition: transform 0.1s;
        }

        /* èº«ä½“ */
        .suit {
            position: absolute;
            bottom: 0;
            left: 15px;
            width: 250px;
            height: 180px;
            background: #37474F; /* æ·±ç°è‰²è¥¿è£… */
            border: 4px solid #000;
            border-radius: 45% 45% 10% 10%;
            z-index: 5;
        }

        .suit-collar-left, .suit-collar-right {
            position: absolute;
            top: 0;
            width: 0;
            height: 0;
            border-top: 70px solid #37474F;
            z-index: 7;
        }
        .suit-collar-left { left: 35px; border-right: 40px solid transparent; }
        .suit-collar-right { right: 35px; border-left: 40px solid transparent; }

        .shirt-v {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 35px solid transparent;
            border-right: 35px solid transparent;
            border-top: 70px solid white;
            z-index: 5;
        }

        .tie {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 90px solid #FFC107; /* æ ‡å¿—æ€§é»„è‰²é¢†å¸¦ */
            z-index: 6;
        }

        /* å¤´éƒ¨ */
        .head-group {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            height: 220px;
            z-index: 20;
        }

        .head-shape {
            width: 100%;
            height: 100%;
            background: #FFCCBC; /* çš®è‚¤é¢œè‰² */
            border: 4px solid #000;
            border-radius: 50% 50% 45% 45%; /* é¹…è›‹è„¸ */
            position: relative;
            overflow: hidden; /* ç”¨äºè£å‰ªè‡ªå®šä¹‰å¤´åƒ */
            z-index: 2;
        }

        /* ä¾§å‘ (åœ°ä¸­æµ·) */
        .hair-tuft {
            position: absolute;
            top: 80px;
            width: 25px;
            height: 50px;
            background: #4E342E;
            border: 3px solid #000;
            z-index: 1;
        }
        .hair-tuft.left { left: -10px; border-radius: 20px 0 0 20px; }
        .hair-tuft.right { right: -10px; border-radius: 0 20px 20px 0; }

        /* è€³æœµ */
        .ear {
            position: absolute;
            top: 100px;
            width: 25px;
            height: 35px;
            background: #FFCCBC;
            border: 3px solid #000;
            z-index: 0;
        }
        .ear.left { left: -15px; border-radius: 100% 0 0 100%; }
        .ear.right { right: -15px; border-radius: 0 100% 100% 0; }

        /* äº”å®˜å®¹å™¨ */
        .face-features {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }

        .eyebrow {
            position: absolute;
            top: 70px;
            width: 60px;
            height: 12px;
            background: #000;
            border-radius: 5px;
        }
        .eyebrow.left { left: 40px; transform: rotate(20deg); }
        .eyebrow.right { right: 40px; transform: rotate(-20deg); }

        /* çœ‰é—´çº¹ */
        .frown-lines {
            position: absolute;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 15px;
        }
        .frown-lines::before, .frown-lines::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 100%;
            background: #000;
            top: 0;
        }
        .frown-lines::before { left: 5px; transform: rotate(10deg); }
        .frown-lines::after { right: 5px; transform: rotate(-10deg); }


        .eye {
            position: absolute;
            top: 95px;
            width: 18px;
            height: 18px;
            background: #000;
            border-radius: 50%;
        }
        .eye.left { left: 60px; }
        .eye.right { right: 60px; }

        .nose {
            position: absolute;
            top: 105px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 40px;
            border: 4px solid #000;
            border-top-color: transparent; /* åªæœ‰ä¸‹åŠéƒ¨åˆ† */
            border-radius: 50%;
            background: #FFAB91; /* é¼»å­ç¨å¾®æ·±ä¸€ç‚¹ */
        }

        .mouth {
            position: absolute;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 30px;
            border-top: 4px solid #000; /* ä¸é«˜å…´çš„å˜´ */
            border-radius: 50% 50% 0 0;
        }

        /* é›ªèŒ„ */
        .cigar {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 70px;
            height: 18px;
            background: #5D4037;
            border: 3px solid #000;
            transform: rotate(15deg);
            border-radius: 5px;
            z-index: 10;
        }
        .cigar-tip {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 10px;
            background: #FF5722;
            border-right: 2px solid #000;
        }
        .smoke {
            position: absolute;
            left: -10px;
            top: -10px;
            width: 10px;
            height: 10px;
            background: #ccc;
            border-radius: 50%;
            opacity: 0;
            animation: smokeFloat 2s infinite;
        }
        @keyframes smokeFloat {
            0% { opacity: 0.8; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-30px) scale(2.5); }
        }

        /* è…¿éƒ¨ */
        .legs {
            position: absolute;
            bottom: -35px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .shoe {
            width: 60px;
            height: 30px;
            background: #000;
            border-radius: 30px 30px 0 0;
        }

        /* --- æˆ˜æŸæ•ˆæœ (CSS ç»˜åˆ¶) --- */
        .damage-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 8;
            pointer-events: none;
        }

        .bruise {
            position: absolute;
            background: radial-gradient(circle, rgba(74, 20, 140, 0.6) 0%, transparent 80%);
            border-radius: 50%;
            display: none;
            mix-blend-mode: multiply;
        }

        /* é¼»è¡€åŠ¨ç”» */
        .nose-bleed {
            position: absolute;
            top: 145px;
            left: 55%; /* ç¨å¾®åä¸€ç‚¹ */
            width: 12px;
            height: 0;
            background: #D50000;
            border-radius: 6px;
            display: none;
        }
        @keyframes bleed {
            0% { height: 0; }
            100% { height: 40px; }
        }

        /* åˆ›å¯è´´ */
        .plaster {
            position: absolute;
            width: 30px;
            height: 10px;
            background: #E0E0E0;
            border: 1px solid #999;
            transform: rotate(-15deg);
            display: none;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .plaster::after {
            content: '';
            position: absolute;
            top: 2px; left: 10px;
            width: 10px; height: 4px;
            background: #fff;
            border-radius: 2px;
        }

        /* è‡ªå®šä¹‰å¤´åƒå›¾ç‰‡ */
        #custom-face-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        /* --- ç©å®¶æ‹³å¥— --- */
        .gloves-layer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .glove-wrapper {
            position: absolute;
            bottom: -50px;
            width: 200px;
            height: 300px;
            pointer-events: auto; /* å…è®¸ç‚¹å‡» */
            cursor: pointer;
            transition: transform 0.05s;
            /* æ‰‹æœºç‚¹å‡»å»é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }

        .glove-wrapper.left { left: 10px; transform-origin: bottom left; }
        .glove-wrapper.right { right: -20px; transform-origin: bottom right; }

        .glove {
            width: 160px;
            height: 180px;
            background: #D32F2F; /* é²œçº¢è‰² */
            border: 5px solid #000;
            border-radius: 50% 50% 40% 40%;
            position: relative;
            box-shadow: inset -15px -15px 0 rgba(0,0,0,0.15);
        }
        .glove-thumb {
            position: absolute;
            width: 70px;
            height: 90px;
            background: #B71C1C;
            border: 5px solid #000;
            border-radius: 40px;
            top: 60px;
            z-index: 2;
        }
        .glove-wrapper.left .glove-thumb { right: -20px; transform: rotate(30deg); }
        .glove-wrapper.right .glove-thumb { left: -20px; transform: rotate(-30deg); }

        .glove-cuff {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 60px;
            background: #1565C0; /* è“è‰²æ‰‹è…• */
            border: 5px solid #000;
            border-radius: 16px;
            z-index: 1;
        }

        /* æ‰“å‡»åŠ¨ç”» */
        .anim-punch-left { animation: punchLeft 0.1s cubic-bezier(0.1, 0.7, 1.0, 0.1) forwards; }
        .anim-punch-right { animation: punchRight 0.1s cubic-bezier(0.1, 0.7, 1.0, 0.1) forwards; }

        @keyframes punchLeft {
            0% { transform: scale(1) translate(0,0); }
            50% { transform: scale(1.1) translate(150px, -200px) rotate(15deg); }
            100% { transform: scale(1) translate(0,0); }
        }
        @keyframes punchRight {
            0% { transform: scale(1) translate(0,0); }
            50% { transform: scale(1.1) translate(-150px, -200px) rotate(-15deg); }
            100% { transform: scale(1) translate(0,0); }
        }

        /* å—å‡»åé¦ˆ */
        .boss-shake { animation: shake 0.2s; }
        @keyframes shake {
            0%, 100% { transform: translateX(-50%) rotate(0); }
            25% { transform: translateX(-55%) rotate(-5deg); }
            75% { transform: translateX(-45%) rotate(5deg); }
        }

        /* é£˜å­—æ•ˆæœ */
        .floating-text {
            position: absolute;
            color: #D32F2F;
            font-weight: 900;
            font-size: 36px;
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff;
            pointer-events: none;
            z-index: 200;
            animation: floatUp 0.8s forwards;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.2); }
        }

        /* æŠ•æ·ç‰© */
        .projectile {
            position: absolute;
            font-size: 40px;
            z-index: 50;
            transition: all 0.4s ease-in;
        }

        /* å¼¹çª— */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            border: 4px solid #333;
        }

    </style>
</head>
<body>

<div id="game-container">
    <!-- UI -->
    <div class="ui-layer">
        <div class="top-controls">
            <button class="btn" onclick="toggleMute()" id="mute-btn">ğŸ”Š éŸ³æ•ˆ: å¼€</button>
            <button class="btn" onclick="openSettings()">ğŸ“· æ¢ä¸ªè„¸</button>
        </div>
        <div class="hp-container">
            <div id="hp-fill"></div>
            <div id="hp-text">1000 / 1000</div>
        </div>
        <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">æ‰‹æœºå¯ç›´æ¥ç‚¹å‡»æ‹³å¥— | PCæŒ‰ A/D å‡ºæ‹³</div>
    </div>

    <!-- æŠ€èƒ½æŒ‰é’® -->
    <div class="skill-bar">
        <div class="skill-icon" onclick="useSkill('egg')">
            ğŸ¥š
            <div class="cooldown-mask" id="cd-egg"></div>
            <div class="key-hint">Q</div>
        </div>
        <div class="skill-icon" onclick="useSkill('bomb')">
            ğŸ’£
            <div class="cooldown-mask" id="cd-bomb"></div>
            <div class="key-hint">W</div>
        </div>
    </div>

    <!-- Boss æœ¬ä½“ -->
    <div id="boss-wrapper">
        <div class="head-group">
            <div class="hair-tuft left"></div>
            <div class="hair-tuft right"></div>
            <div class="ear left"></div>
            <div class="ear right"></div>

            <div class="head-shape">
                <img id="custom-face-img" alt="custom face">

                <div class="face-features" id="default-features">
                    <div class="eyebrow left"></div>
                    <div class="eyebrow right"></div>
                    <div class="frown-lines"></div>
                    <div class="eye left"></div>
                    <div class="eye right"></div>
                    <div class="nose"></div>
                    <div class="mouth"></div>
                    <div class="cigar">
                        <div class="cigar-tip"></div>
                        <div class="smoke"></div>
                    </div>
                </div>

                <!-- æˆ˜æŸå±‚ (å åŠ åœ¨è„¸ä¸Š) -->
                <div class="damage-layer">
                    <div class="bruise" style="top: 85px; left: 50px; width: 40px; height: 40px;" id="bruise-left-eye"></div>
                    <div class="bruise" style="top: 85px; right: 50px; width: 45px; height: 45px;" id="bruise-right-eye"></div>
                    <div class="plaster" style="top: 40px; right: 60px;" id="plaster-head"></div>
                    <div class="nose-bleed" id="nose-bleed"></div>
                </div>
            </div>
        </div>

        <div class="suit">
            <div class="suit-collar-left"></div>
            <div class="suit-collar-right"></div>
            <div class="shirt-v"></div>
            <div class="tie"></div>
        </div>

        <div class="legs">
            <div class="shoe"></div>
            <div class="shoe"></div>
        </div>
    </div>

    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="wall-trim"></div>
    <div class="floor"></div>

    <!-- æ‹³å¥— -->
    <div class="gloves-layer">
        <div class="glove-wrapper left" id="glove-left" onmousedown="handlePunch('left')" ontouchstart="handlePunch('left', event)">
            <div class="glove">
                <div class="glove-thumb"></div>
                <div class="glove-cuff"></div>
            </div>
        </div>
        <div class="glove-wrapper right" id="glove-right" onmousedown="handlePunch('right')" ontouchstart="handlePunch('right', event)">
            <div class="glove">
                <div class="glove-thumb"></div>
                <div class="glove-cuff"></div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div id="settings-modal" class="modal-overlay" onclick="closeSettings(event)">
        <div class="modal-box">
            <h3>æ›´æ¢è€æ¿å¤´åƒ</h3>
            <input type="file" id="upload-input" accept="image/*" style="margin: 10px 0;">
            <br>
            <button class="btn" onclick="resetFace()">æ¢å¤é»˜è®¤</button>
            <button class="btn" onclick="closeSettings(null)">å…³é—­</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-box">
            <h1 style="color:red">K.O.!</h1>
            <p>è€æ¿è¢«ä½ æ‰“é£äº†ï¼</p>
            <button class="btn" onclick="location.reload()" style="font-size:20px; padding: 10px 30px;">å†æ¥ä¸€å±€</button>
        </div>
    </div>
</div>

<script>
    /* --- æ¸¸æˆé…ç½® --- */
    const MAX_HP = 1000;
    let hp = MAX_HP;
    let isGameOver = false;
    let audioEnabled = true;

    // å†·å´ç³»ç»Ÿ
    const skills = {
        egg: { cd: 20, dmg: 20, active: true },
        bomb: { cd: 30, dmg: 30, active: true }
    };

    // éŸ³é¢‘ä¸Šä¸‹æ–‡
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = new AudioContext();

    /* --- æ ¸å¿ƒé€»è¾‘ --- */
    function init() {
        updateHpBar();
        // è‡ªåŠ¨å›è¡€å¾ªç¯ (æ¯ç§’å›20)
        setInterval(() => {
            if (!isGameOver && hp < MAX_HP && hp > 0) {
                hp = Math.min(MAX_HP, hp + 40);
                updateHpBar();
                updateDamageVisuals();
            }
        }, 1000);

        // ç»‘å®šé”®ç›˜
        document.addEventListener('keydown', (e) => {
            if (isGameOver) return;
            const key = e.key.toLowerCase();
            if (key === 'a' || key === 'arrowleft') handlePunch('left');
            if (key === 'd' || key === 'arrowright') handlePunch('right');
            if (key === 'q') useSkill('egg');
            if (key === 'w') useSkill('bomb');
        });

        // ç›‘å¬æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('upload-input').addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('custom-face-img').src = e.target.result;
                    document.getElementById('custom-face-img').style.display = 'block';
                    document.getElementById('default-features').style.display = 'none';
                    closeSettings(null);
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    function handlePunch(side, event) {
        if (event) event.preventDefault(); // é˜²æ­¢è§¦æ‘¸åŒå‡»æ”¾å¤§
        if (isGameOver) return;

        playAudio('punch');

        // åŠ¨ç”»
        const glove = document.getElementById(side === 'left' ? 'glove-left' : 'glove-right');
        const animName = side === 'left' ? 'anim-punch-left' : 'anim-punch-right';

        glove.classList.remove(animName);
        void glove.offsetWidth; // è§¦å‘é‡ç»˜
        glove.classList.add(animName);

        // é€ æˆä¼¤å®³
        setTimeout(() => takeDamage(10), 50);
    }

    function useSkill(type) {
        if (isGameOver || !skills[type].active) return;

        // å¼€å§‹å†·å´
        startCooldown(type);
        playAudio('throw');

        // ç”ŸæˆæŠ•æ·ç‰©
        const item = document.createElement('div');
        item.className = 'projectile';
        item.innerText = type === 'egg' ? 'ğŸ¥š' : 'ğŸ’£';
        item.style.bottom = '0px';
        item.style.left = '50%';
        document.getElementById('game-container').appendChild(item);

        // åŠ¨ç”»
        requestAnimationFrame(() => {
            item.style.transform = `translate(-50%, -400px) scale(1.5) rotate(720deg)`;
        });

        // å‘½ä¸­
        setTimeout(() => {
            item.remove();
            takeDamage(skills[type].dmg);
            if(type === 'bomb') {
                playAudio('boom');
                flashScreen();
            } else {
                playAudio('splat');
            }
        }, 400);
    }

    function takeDamage(amount) {
        hp -= amount;
        updateHpBar();
        showFloatingText(amount);

        // Boss å—å‡»åŠ¨ç”»
        const boss = document.getElementById('boss-wrapper');
        boss.classList.remove('boss-shake');
        void boss.offsetWidth;
        boss.classList.add('boss-shake');

        // æˆ˜æŸæ›´æ–°
        updateDamageVisuals();

        // æ£€æŸ¥ç»“æŸ
        if (hp <= 0) {
            hp = 0;
            updateHpBar();
            gameOver();
        }
    }

    function updateDamageVisuals() {
        const percent = (hp / MAX_HP) * 100;

        // æ·¤é’é€»è¾‘
        document.getElementById('bruise-left-eye').style.display = percent < 90 ? 'block' : 'none';
        document.getElementById('bruise-right-eye').style.display = percent < 70 ? 'block' : 'none';

        // åˆ›å¯è´´é€»è¾‘
        document.getElementById('plaster-head').style.display = percent < 50 ? 'block' : 'none';

        // é¼»è¡€åŠ¨ç”»é€»è¾‘
        const noseBleed = document.getElementById('nose-bleed');
        if (percent < 30) {
            noseBleed.style.display = 'block';
            noseBleed.style.animation = 'bleed 2s infinite';
        } else {
            noseBleed.style.display = 'none';
            noseBleed.style.animation = 'none';
        }

        // æ¿’æ­»æ»¤é•œ
        if (percent < 10) {
            document.querySelector('.head-shape').style.filter = 'grayscale(0.6) sepia(0.4)';
        } else {
            document.querySelector('.head-shape').style.filter = 'none';
        }
    }

    function updateHpBar() {
        const pct = Math.max(0, (hp / MAX_HP) * 100);
        document.getElementById('hp-fill').style.width = pct + '%';
        document.getElementById('hp-text').innerText = Math.floor(hp) + ' / ' + MAX_HP;
    }

    function startCooldown(type) {
        skills[type].active = false;
        const mask = document.getElementById('cd-' + type);
        let time = skills[type].cd;

        mask.style.height = '100%';
        mask.innerText = time;

        const timer = setInterval(() => {
            time--;
            mask.innerText = time;
            mask.style.height = (time / skills[type].cd * 100) + '%';

            if (time <= 0) {
                clearInterval(timer);
                skills[type].active = true;
                mask.innerText = '';
            }
        }, 1000);
    }

    function showFloatingText(num) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = '-' + num;
        el.style.left = (40 + Math.random() * 20) + '%';
        el.style.top = (30 + Math.random() * 10) + '%';
        document.getElementById('game-container').appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function flashScreen() {
        const flash = document.createElement('div');
        flash.style.position = 'absolute';
        flash.style.top = 0; flash.style.left = 0;
        flash.style.width = '100%'; flash.style.height = '100%';
        flash.style.background = 'white';
        flash.style.opacity = 0.8;
        flash.style.zIndex = 200;
        document.getElementById('game-container').appendChild(flash);
        setTimeout(() => flash.remove(), 100);
    }

    function gameOver() {
        isGameOver = true;
        document.getElementById('boss-wrapper').style.transform = 'translate(-50%, 1000px) rotate(180deg)';
        setTimeout(() => {
            document.getElementById('game-over-modal').style.display = 'flex';
        }, 800);
    }

    /* --- éŸ³æ•ˆç³»ç»Ÿ (Web Audio API) --- */
    function playAudio(type) {
        if (!audioEnabled) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'punch') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(40, now + 0.15);
            gain.gain.setValueAtTime(0.5, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.15);
            osc.start(now);
            osc.stop(now + 0.15);
        } else if (type === 'throw') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.linearRampToValueAtTime(300, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'boom') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.exponentialRampToValueAtTime(10, now + 0.4);
            gain.gain.setValueAtTime(0.5, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now);
            osc.stop(now + 0.4);
        } else if (type === 'splat') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
    }

    function toggleMute() {
        audioEnabled = !audioEnabled;
        document.getElementById('mute-btn').innerText = audioEnabled ? "ğŸ”Š éŸ³æ•ˆ: å¼€" : "ğŸ”‡ éŸ³æ•ˆ: å…³";
        if(audioEnabled && audioCtx.state === 'suspended') audioCtx.resume();
    }

    /* --- è®¾ç½®èœå• --- */
    function openSettings() {
        document.getElementById('settings-modal').style.display = 'flex';
    }
    function closeSettings(e) {
        if (!e || e.target.className.includes('modal-overlay') || e.target.tagName === 'BUTTON') {
            document.getElementById('settings-modal').style.display = 'none';
        }
    }
    function resetFace() {
        document.getElementById('custom-face-img').style.display = 'none';
        document.getElementById('default-features').style.display = 'block';
        closeSettings(null);
    }

    // å¯åŠ¨æ¸¸æˆ
    init();

</script>
</body>
</html>
